name: Release ESMF aspect model loader

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version number of the release'
        required: true

jobs:
  prepare-release:
    name: Prepare release
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Sanity check version
        if: ${{ !contains( github.event.inputs.release_version, '-M' ) }}
        run: |
          current_version=$(git tag | tail -1)
          release_version=${{ github.event.inputs.release_version }}
          check_release_version=$(python -c "print(${release_version} > ${current_version})")
          
          if [[ $release_version =~ ^[0-9]+.[0-9]+.[0-9]+$ ] && $check_release_version == 'True'] 
          then
            echo $current_version
            echo $release_version
            echo $check_release_version
            echo version is valid
          else
            echo release version $release_version is invalid
            exit 1
          fi

      - name: Update version number
        run: |
          current_version=$(git tag | tail -1)
          release_version=${{ github.event.inputs.release_version }}
          
          sed -i 's/version = $current_version"/version = $release_version/g' core/esmf-aspect-meta-model-python/pyproject.toml
          git add core/esmf-aspect-meta-model-python/pyproject.toml
          git status
          git commit -m "Update version number to $release_version"
          git tag v$release_version

  publish:
    name: Publish a release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        poetry-version: [ 1.5.0 ]
        os: [ ubuntu-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Run image
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: ${{ matrix.poetry-version }}

      - name: build esmf-aspect-model-loader
        run: |
          cd core/esmf-aspect-meta-model-python
          poetry install
          poetry run download-samm-release
          poetry build -vv

      - name: run tests and code check
        run: |
          cd core/esmf-aspect-meta-model-python
          poetry run tox

      - name: publish esmf-aspect-model-loader
        run:  |
          poetry config pypi-token.pypi pypi-${{ secrets.PYPI_TOKEN }}
          poetry publish -vv
